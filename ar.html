<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMS Plane AR Navigation</title>
<style>
body { margin:0; overflow:hidden; font-family:Arial; }
.overlay {
  position:absolute;
  top:20px;
  left:0;
  right:0;
  text-align:center;
  color:white;
  background:rgba(0,0,0,0.5);
  padding:10px;
  z-index:10;
}
button {
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  padding:12px 20px;
  font-size:16px;
  border:none;
  background:#00cc66;
  color:white;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="overlay">
  <h3 id="placeName"></h3>
  <p id="distance">Tap screen to place path</p>
</div>

<button id="startAR">Start AR</button>

<script type="module">

import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js";

const data = JSON.parse(localStorage.getItem("destination"));
document.getElementById("placeName").innerText = data.name;

let camera, scene, renderer;
let hitTestSource = null;
let pathGroup = null;
let heading = 0;

init();

function init(){

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;

  document.body.appendChild(renderer.domElement);

  document.body.appendChild(ARButton.createButton(renderer, {
    requiredFeatures: ['hit-test']
  }));

  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  scene.add(light);

  renderer.setAnimationLoop(render);
}

function render(timestamp, frame){

  if(frame){

    const referenceSpace = renderer.xr.getReferenceSpace();
    const session = renderer.xr.getSession();

    if(hitTestSource === null){

      session.requestReferenceSpace('viewer').then(space=>{
        session.requestHitTestSource({ space:space }).then(source=>{
          hitTestSource = source;
        });
      });
    }

    if(hitTestSource){

      const hitTestResults = frame.getHitTestResults(hitTestSource);

      if(hitTestResults.length){

        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);

        if(!pathGroup){
          createPath();
          pathGroup.position.set(
            pose.transform.position.x,
            pose.transform.position.y,
            pose.transform.position.z
          );
        }

      }
    }

  }

  renderer.render(scene, camera);
}

function createPath(){

  pathGroup = new THREE.Group();

  const material = new THREE.MeshStandardMaterial({ color:0x00ff66 });

  for(let i=0; i<10; i++){

    const geometry = new THREE.ConeGeometry(0.1, 0.3, 16);
    const arrow = new THREE.Mesh(geometry, material);

    arrow.rotation.x = Math.PI / 2;
    arrow.position.z = -i * 0.5;

    pathGroup.add(arrow);
  }

  scene.add(pathGroup);
}

</script>

</body>
</html>