<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AMS AR Navigation</title>

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="overlay">
  <h3 id="placeName"></h3>
  <p id="distance">Calculating...</p>
</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="logarithmicDepthBuffer: true; precision: mediump;"
  arjs="sourceType: webcam; debugUIEnabled: false;"
>

  <!-- CAMERA WITH PROPER FOV -->
  <a-camera 
    id="camera"
    gps-camera 
    rotation-reader
    camera="fov: 80">
  </a-camera>

  <!-- ARROW IN FRONT -->
  <a-entity id="arrow"
    position="0 0 -8"
    rotation="0 0 180"
    geometry="primitive: cone; radiusBottom: 0.8; height: 2.5"
    material="color: red; metalness:0.3; roughness:0.4"
    scale="2.5 2.5 2.5">
  </a-entity>

</a-scene>

<script>
const data = JSON.parse(localStorage.getItem("destination"));
document.getElementById("placeName").innerText = data.name;

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function distance(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1);
  const Δλ = toRad(lon2-lon1);

  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*
            Math.sin(Δλ/2)**2;

  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function bearing(lat1, lon1, lat2, lon2){
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2-lon1);

  const y = Math.sin(Δλ)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);

  return (toDeg(Math.atan2(y,x))+360)%360;
}

let deviceHeading = 0;

window.addEventListener("deviceorientation", e => {
  deviceHeading = e.alpha || 0;
});

navigator.geolocation.watchPosition(pos => {

  const userLat = pos.coords.latitude;
  const userLon = pos.coords.longitude;

  const d = distance(userLat, userLon, data.lat, data.lon);

  document.getElementById("distance").innerText =
    "Distance: " + d.toFixed(1) + " m";

  if(d < 8){
    alert("You have arrived at " + data.name);
  }

  const targetBearing = bearing(userLat, userLon, data.lat, data.lon);
  const rotation = targetBearing - deviceHeading;

  const arrow = document.getElementById("arrow");
  arrow.setAttribute("rotation", `0 ${rotation} 180`);

}, {
  enableHighAccuracy: true,
  maximumAge: 0,
  timeout: 27000
});
</script>

</body>
</html>