<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AMS Premium AR Navigation</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
body { margin:0; overflow:hidden; font-family:Arial; }

.overlay {
  position:absolute;
  top:20px;
  left:0;
  right:0;
  text-align:center;
  color:white;
  background:rgba(0,0,0,0.5);
  padding:12px;
  z-index:10;
  backdrop-filter: blur(6px);
}

.overlay h3 { margin:0; font-size:18px; }
.overlay p { margin:4px 0 0; font-size:14px; }
</style>
</head>

<body>

<div class="overlay">
  <h3 id="placeName"></h3>
  <p id="distance">Initializing GPS...</p>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="precision: mediump;"
  arjs="sourceType: webcam; debugUIEnabled:false;"
>

  <a-camera id="camera" rotation-reader camera="fov:85"></a-camera>

  <!-- Strong Lighting -->
  <a-light type="ambient" intensity="2"></a-light>
  <a-light type="directional" intensity="1" position="0 10 5"></a-light>

  <!-- PATH CONTAINER -->
  <a-entity id="path" position="0 -1 -2"></a-entity>

</a-scene>

<script>

const data = JSON.parse(localStorage.getItem("destination"));
document.getElementById("placeName").innerText = data.name;

const pathContainer = document.getElementById("path");
let arrowTiles = [];

// Create premium arrow tiles
for(let i=0; i<12; i++){

  const tile = document.createElement("a-cone");

  tile.setAttribute("height", "0.4");
  tile.setAttribute("radius-bottom", "0.25");
  tile.setAttribute("rotation", "90 0 0");
  tile.setAttribute("position", `0 0 ${-i*0.8}`);

  tile.setAttribute("material", `
    color:#00ff66;
    emissive:#00ff66;
    emissiveIntensity:1;
    side:double;
    depthTest:false;
    depthWrite:false;
    transparent:true;
  `);

  pathContainer.appendChild(tile);
  arrowTiles.push(tile);
}

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function calculateDistance(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1);
  const Δλ = toRad(lon2-lon1);

  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2) *
            Math.sin(Δλ/2)**2;

  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function calculateBearing(lat1, lon1, lat2, lon2){
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2-lon1);

  const y = Math.sin(Δλ)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);

  return (toDeg(Math.atan2(y,x))+360)%360;
}

// Smooth compass filter
let heading = 0;
let smoothHeading = 0;

window.addEventListener("deviceorientation", e=>{
  heading = e.alpha || 0;
  smoothHeading = smoothHeading * 0.9 + heading * 0.1;
});

navigator.geolocation.watchPosition(position => {

  const userLat = position.coords.latitude;
  const userLon = position.coords.longitude;

  const dist = calculateDistance(userLat,userLon,data.lat,data.lon);

  document.getElementById("distance").innerText =
    "Distance: " + dist.toFixed(1) + " m";

  if(dist < 8){
    if(navigator.vibrate) navigator.vibrate(500);
    alert("You have arrived at " + data.name);
  }

  const targetBearing =
    calculateBearing(userLat,userLon,data.lat,data.lon);

  const rotation = targetBearing - smoothHeading;

  pathContainer.setAttribute("rotation", `0 ${rotation} 0`);

},
error=>{
  document.getElementById("distance").innerText =
    "GPS Error: " + error.message;
},
{
  enableHighAccuracy:true,
  maximumAge:0,
  timeout:20000
});

// Animate arrows forward
function animateArrows(){

  arrowTiles.forEach(tile=>{
    let pos = tile.getAttribute("position");

    pos.z += 0.03;

    if(pos.z > 1){
      pos.z = -8;
    }

    tile.setAttribute("position", pos);
  });

  requestAnimationFrame(animateArrows);
}

animateArrows();

</script>

</body>
</html>