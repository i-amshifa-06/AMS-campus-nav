<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMS Campus AR</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
body{margin:0;overflow:hidden;font-family:Arial;}
.overlay{
  position:absolute;
  top:20px;
  left:0;
  right:0;
  text-align:center;
  color:white;
  background:rgba(0,0,0,0.6);
  padding:10px;
  z-index:10;
}
</style>
</head>

<body>

<div class="overlay">
  <h3 id="placeName"></h3>
  <p id="distance">Initializing...</p>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="precision: mediump;"
  arjs="sourceType:webcam; debugUIEnabled:false;"
>

<a-camera camera="fov:90"></a-camera>

<a-entity id="arrowContainer" position="0 -1 -5"></a-entity>

</a-scene>

<script>

// ===== DESTINATION =====
const destination = JSON.parse(localStorage.getItem("destination"));
document.getElementById("placeName").innerText = destination.name;

// ===== SIMPLE NODES =====
const nodes = {
  gate:{lat:13.147000,lon:80.058500},
  ece:{lat:13.146888,lon:80.058802},
  canteen:{lat:13.146777,lon:80.059334},
  eee:{lat:13.147037,lon:80.059698}
};

const edges={
  gate:["ece"],
  ece:["gate","canteen","eee"],
  canteen:["ece"],
  eee:["ece"]
};

// ===== MATCH =====
function getKey(name){
  name=name.toLowerCase();
  if(name.includes("ece")) return "ece";
  if(name.includes("eee")) return "eee";
  if(name.includes("canteen")) return "canteen";
  return "ece";
}

const destinationKey=getKey(destination.name);

// ===== DISTANCE =====
function toRad(d){return d*Math.PI/180;}
function dist(a,b){
  const R=6371e3;
  const φ1=toRad(nodes[a].lat);
  const φ2=toRad(nodes[b].lat);
  const Δφ=toRad(nodes[b].lat-nodes[a].lat);
  const Δλ=toRad(nodes[b].lon-nodes[a].lon);
  const x=Math.sin(Δφ/2)**2+
          Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// ===== ROUTE =====
function shortest(start,end){
  if(start===end) return [start];
  return [start,end];
}

// ===== ARROWS (LIGHTWEIGHT) =====
const container=document.getElementById("arrowContainer");

let arrows=[];
for(let i=0;i<8;i++){
  const plane=document.createElement("a-plane");
  plane.setAttribute("width","0.4");
  plane.setAttribute("height","0.6");
  plane.setAttribute("rotation","-90 0 0");
  plane.setAttribute("color","white");
  plane.setAttribute("position",`0 0 ${-i*1}`);
  container.appendChild(plane);
  arrows.push(plane);
}

// ===== COMPASS =====
let heading=0;
window.addEventListener("deviceorientation",e=>{
  heading=e.alpha||0;
});

// ===== GPS =====
navigator.geolocation.getCurrentPosition(pos=>{

  const userLat=pos.coords.latitude;
  const userLon=pos.coords.longitude;

  const start="ece"; // simplified for speed
  const route=shortest(start,destinationKey);

  document.getElementById("distance").innerText=
    "Route: "+route.join(" → ");

  const target=nodes[destinationKey];

  const bearing=Math.atan2(
    target.lon-userLon,
    target.lat-userLat
  )*180/Math.PI;

  container.setAttribute("rotation",
    `0 ${bearing-heading} 0`);

});


// ===== LIGHT ANIMATION =====
function animate(){
  arrows.forEach(a=>{
    let pos=a.getAttribute("position");
    pos.z+=0.1;
    if(pos.z>1) pos.z=-8;
    a.setAttribute("position",pos);
  });
  requestAnimationFrame(animate);
}
animate();

</script>
</body>
</html>