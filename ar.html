<!DOCTYPE html>
<html>
<head>
  <title>AMS AR Navigation</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body style="margin:0; overflow:hidden;">

<a-scene embedded arjs="sourceType: webcam; gpsMinDistance: 5;">

  <a-camera gps-camera rotation-reader></a-camera>

  <a-entity id="arrow"
            geometry="primitive: cone; radiusBottom: 1; height: 3"
            material="color: red"
            gps-entity-place=""
            scale="5 5 5">
  </a-entity>

  <a-text id="label"
          gps-entity-place=""
          scale="20 20 20"
          color="blue">
  </a-text>

</a-scene>

<script>
const data = JSON.parse(localStorage.getItem("destination"));

const arrow = document.getElementById("arrow");
const label = document.getElementById("label");

arrow.setAttribute("gps-entity-place",
  `latitude: ${data.lat}; longitude: ${data.lon};`);

label.setAttribute("gps-entity-place",
  `latitude: ${data.lat}; longitude: ${data.lon};`);

label.setAttribute("value", data.name);

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function distance(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1);
  const Δλ = toRad(lon2-lon1);
  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*
            Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

navigator.geolocation.watchPosition(pos => {
  const d = distance(
    pos.coords.latitude,
    pos.coords.longitude,
    data.lat,
    data.lon
  );

  if(d < 8){
    alert("You have arrived at " + data.name);
  }
});
</script>

</body>
</html>
